name: ğŸ¥ KHAKISHOP CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # ë§¤ì£¼ ì¼ìš”ì¼ ì˜¤ì „ 9ì‹œì— ì„±ëŠ¥ ê²€ì‚¬ ì‹¤í–‰
    - cron: '0 9 * * 0'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

env:
  NODE_VERSION: '18'

jobs:
  # ================================================================================
  # ğŸ” Health Check & Quality Assurance
  # ================================================================================
  health-check:
    name: ğŸ¥ Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¥ Install dependencies
        run: npm ci
        
      - name: ğŸ¥ Run health check
        run: npm run health-check
        
      - name: ğŸ“‹ Run linting
        run: npm run lint
        
      - name: ğŸ”§ Check TypeScript
        run: npx tsc --noEmit

  # ================================================================================
  # ğŸ”¨ Build & Test
  # ================================================================================
  build:
    name: ğŸ”¨ Build & Test
    runs-on: ubuntu-latest
    needs: health-check
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¥ Install dependencies
        run: npm ci
        
      - name: ğŸ”¨ Build application
        run: npm run build
        
      - name: ğŸ’¾ Cache build artifacts
        uses: actions/cache@v3
        with:
          path: .next
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-

  # ================================================================================
  # ğŸ§ª E2E Testing (ì¡°ê±´ë¶€ ì‹¤í–‰)
  # ================================================================================
  e2e-test:
    name: ğŸ§ª E2E Tests
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¥ Install dependencies
        run: npm ci
        
      - name: ğŸ­ Install Playwright
        run: npx playwright install --with-deps
        
      - name: ğŸ”¨ Build application
        run: npm run build
        
      - name: ğŸ§ª Run E2E tests
        run: npm run test:e2e
        
      - name: ğŸ“„ Upload test results
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

  # ================================================================================
  # ğŸš€ Deployment Status Check
  # ================================================================================
  deployment-ready:
    name: âœ… Deployment Ready
    runs-on: ubuntu-latest
    needs: [health-check, build]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ‰ All checks passed
        run: |
          echo "ğŸ‰ All quality checks passed!"
          echo "âœ… Health check: PASSED"
          echo "âœ… Build: PASSED"
          echo "ğŸš€ Ready for deployment!"

  # ================================================================================
  # ğŸ“Š Performance Audit (ì£¼ê°„ ì‹¤í–‰)
  # ================================================================================
  performance-audit:
    name: ğŸ“Š Performance Audit
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¥ Install dependencies
        run: npm ci
        
      - name: ğŸ”¨ Build application
        run: npm run build
        
      - name: ğŸš€ Start server
        run: npm start &
        
      - name: â³ Wait for server
        run: sleep 10
        
      - name: ğŸƒ Run Lighthouse audit
        run: npm run lighthouse
        
      - name: ğŸ“„ Upload Lighthouse report
        uses: actions/upload-artifact@v3
        with:
          name: lighthouse-report
          path: test-results/
          retention-days: 30 